<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Cal-FIT | Scan Results</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
</head>

<body>
  <header>
    <div class="logo">Cal-FIT</div>
    <nav class="main-nav">
      <a href="{{ url_for('dashboard') }}">Home</a>
      <a href="#explore">Explore</a>
      <a href="#about">About Us</a>
      <a href="{{ url_for('profile') }}">Profile</a>
    </nav>
  </header>

  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
  <div class="flash-messages">
    {% for category, message in messages %}
    <div class="flash {{ category }}">{{ message }}</div>
    {% endfor %}
  </div>
  {% endif %}
  {% endwith %}

  {% if barcode_processed and scan_data and scan_data.structured_nutrients %}
  <div class="results">
    <h2>Barcode Scan Results</h2>

    <!-- DESCRIPTION SECTION -->
    <div class="description-section">
      <h3 class="section-title">Description</h3>
      <div class="description-content">
        <div class="product-info-desc">
          {% if scan_data.product_image_url %}
          <img src="{{ scan_data.product_image_url }}" alt="{{ scan_data.product_name }}" class="product-image-desc">
          {% endif %}
          <div class="product-details">
            <div class="product-name-desc">{{ scan_data.product_name }}</div>

            <!-- Community Warnings Section -->
            {% set cw = community_warnings or {} %}
            {% if cw.get('total_reports', 0) > 0 %}
            <div class="community-warnings warning-level-{{ cw.get('warning_level', 'none') }}">
              <div class="warning-header">
                <span class="warning-icon"></span>
                <span class="warning-title">Community Insights</span>
                <span class="report-count">(Based on {{ cw.get('total_reports', 0) }} report{% if cw.get('total_reports', 0) != 1 %}s{% endif %})</span>
              </div>

              {% if cw.get('summary_message') %}
              <div class="warning-summary">{{ cw.get('summary_message') }}</div>
              {% endif %}

              {% if cw.get('insights') %}
              <div class="insights-list">
                {% for insight in cw.get('insights', [])[:3] %}
                <div class="insight-item severity-{{ insight.severity }}">
                  <span class="insight-icon"></span>
                  <div class="insight-content">
                    <p class="insight-text">{{ insight.text }}</p>
                    <span class="insight-category">{{ insight.category }}</span>
                  </div>
                </div>
                {% endfor %}
              </div>
              {% endif %}

              {% if cw.get('positive_reports', 0) > 0 %}
              <div class="positive-note">
                <span class="positive-icon"></span>
                <span>{{ cw.get('positive_reports', 0) }} user{% if cw.get('positive_reports', 0) != 1 %}s{% endif %} reported positive experiences</span>
              </div>
              {% endif %}
            </div>
            {% else %}
            <div class="no-warnings">
              <span class="check-icon"></span>
              <span>No community reports available for this product</span>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- NUTRIENTS SECTION -->
    <h3 class="section-title">Nutritional Information</h3>
    <div class="nutrient-grid">
      {% for nutrient in scan_data.structured_nutrients %}
      <div class="nutrient-card" onclick="toggleCard(this)">
        <div class="nutrient-name">{{ nutrient.nutrient }}</div>
        <div class="nutrient-value">{{ nutrient.value }} {{ nutrient.unit }}</div>
        <span class="nutrient-status status-{{ nutrient.status|lower }}">{{ nutrient.status }}</span>

        <!-- Hidden AI Analysis Section -->
        <div class="ai-analysis-section" style="display: none;">
          <div class="ai-divider"></div>
          {% if nutrient.ai_analysis %}
          <div class="ai-analysis-content">
            <p class="ai-label">Personalized for You:</p>
            <p class="ai-text">{{ nutrient.ai_analysis }}</p>
          </div>
          {% endif %}
          {% if nutrient.message %}
          <div class="general-message">
            <p class="general-label">General Info:</p>
            <p class="general-text">{{ nutrient.message }}</p>
          </div>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>

    <div class="actions">
      <form id="add-to-diet-form" action="{{ url_for('add_to_diet') }}" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="btn">Add to Diet</button>
      </form>
      <a href="{{ url_for('scan_label') }}" class="btn">Scan Another Item</a>
      <a href="{{ url_for('dashboard') }}" class="btn">Back to Dashboard</a>
    </div>

    <div id="flash-messages"></div>
  </div>

  {% else %}
  <!-- Default Upload Page -->
  <div style="position: relative; z-index: 1; text-align: center; margin-top: 60px;">
    <p style="max-width: 700px; margin: 0 auto 30px auto; font-size: 18px; color: #252601;">
      Cal-FIT provides comprehensive analysis of your food labels, offering valuable insights into nutritional content
      and potential health risks.
    </p>
  </div>

  <div class="parent">
    <div class="container">
      <h2>Upload a Food Label</h2>
      <form method="POST" enctype="multipart/form-data" action="{{ url_for('scan_label') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="file" name="label_image" accept="image/*" required>
        <button type="submit">Scan</button>
      </form>
    </div>
    <div class="container">
      <h2>Scan a Barcode</h2>
      <form method="POST" enctype="multipart/form-data" action="{{ url_for('scan_label') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="file" name="barcode_image" accept="image/*" required>
        <button type="submit">Scan Barcode</button>
      </form>
    </div>
  </div>

  <div class="text">
    <h1>How To Use Cal-FIT</h1>
  </div>
  <div class="tutorial">
    <div class="step1">
      <p>1</p>
      <h1>Scan</h1>
      <p>Scan your item using camera or uploading an image</p>
    </div>
    <div class="step2">
      <p>2</p>
      <h1>Read</h1>
      <p>Get results that highlight the good and bad in your food, backed by real nutritional science.</p>
    </div>
    <div class="step3">
      <p>3</p>
      <h1>Eat</h1>
      <p>Eat based on personalized suggestions tailored to your diet plan.</p>
    </div>
  </div>
  {% endif %}

  <script>
    function toggleCard(card) {
      const aiSection = card.querySelector('.ai-analysis-section');
      const allCards = document.querySelectorAll('.nutrient-card');

      if (card.classList.contains('expanded')) {
        card.classList.remove('expanded');
        aiSection.style.display = 'none';
      } else {
        allCards.forEach(c => {
          c.classList.remove('expanded');
          const section = c.querySelector('.ai-analysis-section');
          if (section) section.style.display = 'none';
        });

        card.classList.add('expanded');
        aiSection.style.display = 'block';
      }
    }

    document.getElementById("add-to-diet-form")?.addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      const flashBox = document.getElementById("flash-messages");

      try {
        const response = await fetch(this.action, { method: "POST", body: formData });
        const result = await response.json();

        flashBox.innerHTML = `<div class="flash ${result.status}"><p>${result.message}</p></div>`;
        setTimeout(() => flashBox.innerHTML = '', 3000);

        if (result.status === 'success') this.style.display = 'none';
      } catch (error) {
        console.error('Error:', error);
        flashBox.innerHTML = `<div class="flash error"><p>Network error occurred</p></div>`;
        setTimeout(() => flashBox.innerHTML = '', 3000);
      }
    });
  </script>

</body>
</html>