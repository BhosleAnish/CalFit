<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cal-FIT | Scan Label</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/scan_label.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
  <style>
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .loading-overlay.active {
      display: flex;
      opacity: 1;
    }

    .loading-content {
      text-align: center;
      animation: fadeInScale 0.5s ease-out;
    }

    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: scale(0.8);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .loading-text {
      color: #10B981;
      font-size: 24px;
      font-weight: 600;
      margin-top: 20px;
      animation: pulse-text 1.5s ease-in-out infinite;
    }

    @keyframes pulse-text {
      0%, 100% {
        opacity: 0.6;
      }
      50% {
        opacity: 1;
      }
    }

    .loading-subtext {
      color: #9CA3AF;
      font-size: 14px;
      margin-top: 10px;
      animation: fadeInOut 2s ease-in-out infinite;
    }

    @keyframes fadeInOut {
      0%, 100% {
        opacity: 0.4;
      }
      50% {
        opacity: 0.8;
      }
    }

    .progress-container {
      width: 300px;
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
      margin: 20px auto;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #10B981, #06B6D4);
      border-radius: 2px;
      animation: progressMove 2s ease-in-out infinite;
    }

    @keyframes progressMove {
      0% {
        width: 0%;
        margin-left: 0%;
      }
      50% {
        width: 50%;
        margin-left: 25%;
      }
      100% {
        width: 0%;
        margin-left: 100%;
      }
    }

    /* Cropper Modal */
    .cropper-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(10px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .cropper-modal.active {
      display: flex;
      opacity: 1;
    }

    .cropper-container-wrapper {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 30px;
      max-width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .cropper-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .cropper-header h3 {
      color: #10B981;
      font-size: 24px;
      margin: 0;
    }

    .close-cropper {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      font-size: 28px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      line-height: 1;
    }

    .close-cropper:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .cropper-image-container {
      max-width: 800px;
      max-height: 500px;
      margin: 0 auto 20px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 8px;
      overflow: hidden;
    }

    .cropper-image-container img {
      max-width: 100%;
      display: block;
    }

    .cropper-controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    .cropper-btn {
      background-color: #10B981;
      border: none;
      color: white;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      transition: all 0.3s;
    }

    .cropper-btn:hover {
      background-color: #059669;
      transform: translateY(-2px);
    }

    .cropper-btn.secondary {
      background-color: #000000;
    }

    .cropper-btn.secondary:hover {
      background-color: #000000;
    }

    .cropper-btn.danger {
      background-color: #EF4444;
    }

    .cropper-btn.danger:hover {
      background-color: #DC2626;
    }

    /* Cropper.js custom styling */
    .cropper-view-box,
    .cropper-face {
      border: 2px solid #10B981 !important;
      outline: none;
    }

    .cropper-line,
    .cropper-point {
      background-color: #10B981 !important;
    }

    .cropper-point.point-se {
      width: 8px !important;
      height: 8px !important;
    }
  </style>
</head>
<body>
<header>
  <div class="logo">Cal-FIT</div>
  <nav class="main-nav">
    <a href="{{ url_for('dashboard') }}">Home</a>
    <a href="{{ url_for('scan_label') }}" class="active">Scan</a>
    <a href="{{ url_for('profile') }}">Profile</a>
  </nav>
</header>

<div style="position: relative; z-index: 1; text-align: center; margin-top: 60px;">
  <p style="max-width: 700px; margin: 0 auto 30px auto; font-size: 18px; color: black;">
    Cal-FIT provides comprehensive analysis of your food labels, offering valuable insights into nutritional content and potential health risks.
  </p>
</div>

<div class="parent">
  <!-- Card 1 -->
  <div class="container">
    <h2>Upload a Food Label</h2>
    <form method="POST" enctype="multipart/form-data" id="labelForm">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="file" name="label_image" id="labelImage" accept="image/*">
      <button type="submit">Scan</button>
    </form>
  </div>
  
  <!-- Card 2 -->
  <div class="container">
    <h2>Scan a Barcode</h2>
    <form method="POST" enctype="multipart/form-data" id="barcodeForm">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="file" name="barcode_image" id="barcodeImage" accept="image/*">
      <button type="submit">Scan Barcode</button>
    </form>
  </div>
</div>




<!-- Cropper Modal -->
<div class="cropper-modal" id="cropperModal">
  <div class="cropper-container-wrapper">
    <div class="cropper-header">
      <h3>Edit Your Image</h3>
      <button class="close-cropper" id="closeCropper">&times;</button>
    </div>
    
    <div class="cropper-image-container">
      <img id="cropperImage" src="" alt="Image to crop">
    </div>
    
    <div class="cropper-controls">
      <button type="button" class="cropper-btn secondary" id="rotateLeft">↶ Rotate Left</button>
      <button type="button" class="cropper-btn secondary" id="rotateRight">↷ Rotate Right</button>
      <button type="button" class="cropper-btn secondary" id="resetCrop">↺ Reset</button>
      <button type="button" class="cropper-btn" id="applyCrop">✓ Done - Proceed to Scan</button>
      <button type="button" class="cropper-btn danger" id="cancelCrop">✕ Cancel</button>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-content">
    <svg width="200" height="200" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="scanGradient" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color:#10B981;stop-opacity:0" />
          <stop offset="50%" style="stop-color:#10B981;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#10B981;stop-opacity:0" />
        </linearGradient>
        
        <filter id="glow">
          <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
          <feMerge>
            <feMergeNode in="coloredBlur"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
      </defs>
      
      <circle cx="100" cy="100" r="90" fill="none" stroke="rgba(16, 185, 129, 0.1)" stroke-width="2">
        <animate attributeName="r" values="85;95;85" dur="2s" repeatCount="indefinite"/>
        <animate attributeName="opacity" values="0.3;0.6;0.3" dur="2s" repeatCount="indefinite"/>
      </circle>
      
      <g transform="translate(60, 40)">
        <rect x="0" y="0" width="80" height="100" rx="4" fill="rgba(255, 255, 255, 0.1)" 
              stroke="#10B981" stroke-width="2" filter="url(#glow)">
          <animate attributeName="opacity" values="0.8;1;0.8" dur="1.5s" repeatCount="indefinite"/>
        </rect>
        
        <path d="M 60 0 L 80 0 L 80 20 Z" fill="rgba(16, 185, 129, 0.3)" stroke="#10B981" stroke-width="1"/>
        <path d="M 60 0 L 60 20 L 80 20" fill="none" stroke="#10B981" stroke-width="1" stroke-dasharray="2,2"/>
        
        <rect x="10" y="25" width="50" height="3" rx="1.5" fill="rgba(16, 185, 129, 0.4)">
          <animate attributeName="opacity" values="0.4;0.8;0.4" dur="1s" begin="0s" repeatCount="indefinite"/>
        </rect>
        <rect x="10" y="35" width="60" height="3" rx="1.5" fill="rgba(16, 185, 129, 0.4)">
          <animate attributeName="opacity" values="0.4;0.8;0.4" dur="1s" begin="0.2s" repeatCount="indefinite"/>
        </rect>
        <rect x="10" y="45" width="45" height="3" rx="1.5" fill="rgba(16, 185, 129, 0.4)">
          <animate attributeName="opacity" values="0.4;0.8;0.4" dur="1s" begin="0.4s" repeatCount="indefinite"/>
        </rect>
        <rect x="10" y="55" width="55" height="3" rx="1.5" fill="rgba(16, 185, 129, 0.4)">
          <animate attributeName="opacity" values="0.4;0.8;0.4" dur="1s" begin="0.6s" repeatCount="indefinite"/>
        </rect>
        <rect x="10" y="65" width="40" height="3" rx="1.5" fill="rgba(16, 185, 129, 0.4)">
          <animate attributeName="opacity" values="0.4;0.8;0.4" dur="1s" begin="0.8s" repeatCount="indefinite"/>
        </rect>
        <rect x="10" y="75" width="50" height="3" rx="1.5" fill="rgba(16, 185, 129, 0.4)">
          <animate attributeName="opacity" values="0.4;0.8;0.4" dur="1s" begin="1s" repeatCount="indefinite"/>
        </rect>
      </g>
      
      <rect x="60" y="40" width="80" height="4" fill="url(#scanGradient)" opacity="0.8" filter="url(#glow)">
        <animate attributeName="y" values="40;140;40" dur="2s" repeatCount="indefinite"/>
      </rect>
      
      <g opacity="0.6">
        <circle cx="70" cy="60" r="2" fill="#10B981">
          <animate attributeName="cy" values="60;130;60" dur="2.5s" repeatCount="indefinite"/>
          <animate attributeName="opacity" values="0;1;0" dur="2.5s" repeatCount="indefinite"/>
        </circle>
        <circle cx="90" cy="70" r="2" fill="#06B6D4">
          <animate attributeName="cy" values="70;140;70" dur="2.8s" repeatCount="indefinite"/>
          <animate attributeName="opacity" values="0;1;0" dur="2.8s" repeatCount="indefinite"/>
        </circle>
        <circle cx="110" cy="65" r="2" fill="#10B981">
          <animate attributeName="cy" values="65;135;65" dur="2.3s" repeatCount="indefinite"/>
          <animate attributeName="opacity" values="0;1;0" dur="2.3s" repeatCount="indefinite"/>
        </circle>
        <circle cx="130" cy="75" r="2" fill="#06B6D4">
          <animate attributeName="cy" values="75;145;75" dur="2.6s" repeatCount="indefinite"/>
          <animate attributeName="opacity" values="0;1;0" dur="2.6s" repeatCount="indefinite"/>
        </circle>
      </g>
      
      <circle cx="100" cy="100" r="95" fill="none" stroke="rgba(16, 185, 129, 0.2)" stroke-width="1" 
              stroke-dasharray="10 5" transform-origin="100 100">
        <animateTransform attributeName="transform" type="rotate" from="0 100 100" to="360 100 100" 
                          dur="8s" repeatCount="indefinite"/>
      </circle>
      
      <g opacity="0.4">
        <text x="75" y="150" font-family="monospace" font-size="10" fill="#10B981">01</text>
        <animateTransform attributeName="transform" type="translate" values="0,0; 0,-120" 
                          dur="3s" repeatCount="indefinite"/>
        <animate attributeName="opacity" values="0;0.6;0" dur="3s" repeatCount="indefinite"/>
      </g>
      <g opacity="0.4">
        <text x="115" y="155" font-family="monospace" font-size="10" fill="#06B6D4">10</text>
        <animateTransform attributeName="transform" type="translate" values="0,0; 0,-130" 
                          dur="3.5s" repeatCount="indefinite"/>
        <animate attributeName="opacity" values="0;0.6;0" dur="3.5s" repeatCount="indefinite"/>
      </g>
      
      <g transform="translate(100, 100)" opacity="0.6">
        <circle r="8" fill="none" stroke="#10B981" stroke-width="2">
          <animate attributeName="r" values="6;10;6" dur="1s" repeatCount="indefinite"/>
        </circle>
        <circle r="3" fill="#10B981">
          <animate attributeName="opacity" values="1;0.5;1" dur="1s" repeatCount="indefinite"/>
        </circle>
      </g>
    </svg>

    <div class="loading-text" id="loadingText">Analyzing your food label...</div>
    <div class="loading-subtext">This may take a few moments</div>
    
    <div class="progress-container">
      <div class="progress-bar"></div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
  let cropper = null;
  let currentForm = null;
  let currentFileInput = null;
  let pendingSubmit = false;

  // Elements
  const labelForm = document.getElementById('labelForm');
  const barcodeForm = document.getElementById('barcodeForm');
  const labelImage = document.getElementById('labelImage');
  const barcodeImage = document.getElementById('barcodeImage');
  const cropperModal = document.getElementById('cropperModal');
  const cropperImage = document.getElementById('cropperImage');
  const closeCropper = document.getElementById('closeCropper');
  const rotateLeft = document.getElementById('rotateLeft');
  const rotateRight = document.getElementById('rotateRight');
  const resetCrop = document.getElementById('resetCrop');
  const applyCrop = document.getElementById('applyCrop');
  const cancelCrop = document.getElementById('cancelCrop');
  const loadingOverlay = document.getElementById('loadingOverlay');
  const loadingText = document.getElementById('loadingText');

  // Handle Label Form Submission
  labelForm.addEventListener('submit', function(e) {
    const fileInput = document.getElementById('labelImage');
    
    if (!fileInput.files || fileInput.files.length === 0) {
      e.preventDefault();
      alert('Please select an image file first');
      return;
    }

    // If already processed (after cropping), proceed with normal submission
    if (pendingSubmit) {
      pendingSubmit = false;
      
      // Prevent default form submission
      e.preventDefault();
      
      // Show loading overlay immediately
      loadingText.textContent = 'Analyzing your food label...';
      loadingOverlay.style.display = 'flex';
      loadingOverlay.offsetHeight;
      loadingOverlay.classList.add('active');
      
      // Submit form after a small delay to ensure overlay is visible
      setTimeout(() => {
        e.target.submit();
      }, 100);
      return;
    }

    // First time - show cropper
    e.preventDefault();
    openCropperModal(fileInput, labelForm, 'label');
  });

  // Handle Barcode Form Submission
  barcodeForm.addEventListener('submit', function(e) {
    const fileInput = document.getElementById('barcodeImage');
    
    if (!fileInput.files || fileInput.files.length === 0) {
      e.preventDefault();
      alert('Please select an image file first');
      return;
    }

    // If already processed (after cropping), proceed with normal submission
    if (pendingSubmit) {
      pendingSubmit = false;
      
      // Prevent default form submission
      e.preventDefault();
      
      // Show loading overlay immediately
      loadingText.textContent = 'Scanning barcode...';
      loadingOverlay.style.display = 'flex';
      loadingOverlay.offsetHeight;
      loadingOverlay.classList.add('active');
      
      // Submit form after a small delay to ensure overlay is visible
      setTimeout(() => {
        e.target.submit();
      }, 100);
      return;
    }

    // First time - show cropper
    e.preventDefault();
    openCropperModal(fileInput, barcodeForm, 'barcode');
  });

  // Open cropper modal
  function openCropperModal(fileInput, form, scanType) {
    const file = fileInput.files[0];
    
    // Validate file type
    if (!file.type.match('image.*')) {
      alert('Please select a valid image file');
      return;
    }

    currentForm = form;
    currentFileInput = fileInput;

    const reader = new FileReader();
    reader.onload = function(e) {
      cropperImage.src = e.target.result;
      cropperModal.classList.add('active');
      
      // Initialize cropper
      if (cropper) {
        cropper.destroy();
      }
      
      cropper = new Cropper(cropperImage, {
        aspectRatio: NaN,
        viewMode: 1,
        background: false,
        autoCropArea: 0.9,
        responsive: true,
        restore: true,
        guides: true,
        center: true,
        highlight: true,
        cropBoxMovable: true,
        cropBoxResizable: true,
        toggleDragModeOnDblclick: false,
      });
    };
    reader.readAsDataURL(file);
  }

  // Close cropper modal
  function closeCropperModal() {
    cropperModal.classList.remove('active');
    if (cropper) {
      cropper.destroy();
      cropper = null;
    }
    currentForm = null;
    currentFileInput = null;
  }

  // Rotation controls
  rotateLeft.addEventListener('click', () => {
    if (cropper) cropper.rotate(-90);
  });

  rotateRight.addEventListener('click', () => {
    if (cropper) cropper.rotate(90);
  });

  resetCrop.addEventListener('click', () => {
    if (cropper) cropper.reset();
  });

  // Cancel crop
  cancelCrop.addEventListener('click', () => {
    closeCropperModal();
    // Reset file input
    if (currentFileInput) {
      currentFileInput.value = '';
    }
  });

  closeCropper.addEventListener('click', () => {
    closeCropperModal();
    // Reset file input
    if (currentFileInput) {
      currentFileInput.value = '';
    }
  });

  // Apply crop and submit
  applyCrop.addEventListener('click', () => {
    if (!cropper || !currentForm) return;

    // Get cropped canvas
    const canvas = cropper.getCroppedCanvas({
      maxWidth: 2048,
      maxHeight: 2048,
      fillColor: '#fff',
      imageSmoothingEnabled: true,
      imageSmoothingQuality: 'high',
    });

    // Convert to blob
    canvas.toBlob((blob) => {
      // Create new file from blob
      const file = new File([blob], 'cropped_image.jpg', { type: 'image/jpeg' });
      
      // Create new DataTransfer to set file input
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      currentFileInput.files = dataTransfer.files;

      // Set flag to allow submission
      pendingSubmit = true;

      // Close modal
      closeCropperModal();

      // Trigger form submission
      currentForm.dispatchEvent(new Event('submit', { cancelable: true }));
    }, 'image/jpeg', 0.92);
  });

  // Hide overlay on page load with error
  window.addEventListener('load', function() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('error')) {
      loadingOverlay.classList.remove('active');
      loadingOverlay.style.display = 'none';
    }
  });

  // Prevent back button from showing overlay
  window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
      loadingOverlay.classList.remove('active');
      loadingOverlay.style.display = 'none';
    }
  });
</script>

</body>
</html>