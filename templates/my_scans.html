<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>My Scans | Cal-FIT</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/my_scans.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
</head>

<body>
    <script src="https://unpkg.com/@studio-freight/lenis@1.0.42/dist/lenis.min.js"></script>

    <header>
        <div class="logo">Cal-FIT</div>
        <nav class="main-nav">
            <a href="{{ url_for('dashboard') }}">Home</a>
            <a href="#explore">Explore</a>
            <a href="{{ url_for('about') }}">About Us</a>
            <a href="{{ url_for('profile') }}">Profile</a>
        </nav>
    </header>

    <div class="scans-container">
        <div class="scans-wrapper">
            <a href="{{ url_for('profile') }}" class="back-link">‚Üê Back to Profile</a>

            <div class="page-header">
                <h1>My Nutrition Scans</h1>
                <p>View and manage all your scanned food items</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalScans">0</h3>
                    <p>Total Scans</p>
                </div>
                <div class="stat-card">
                    <h3 id="recentScans">0</h3>
                    <p>This Week</p>
                </div>
                <div class="stat-card">
                    <h3 id="highRiskCount">0</h3>
                    <p>High Risk Items</p>
                </div>
            </div>

            <div class="filters-section">
                <input type="text" id="searchInput" placeholder="üîç Search by product name...">
                <select id="sortSelect">
                    <option value="date-desc">Newest First</option>
                    <option value="date-asc">Oldest First</option>
                    <option value="name-asc">Name A-Z</option>
                    <option value="name-desc">Name Z-A</option>
                </select>
                <button class="filter-btn" onclick="applyFilters()">Apply Filters</button>
                <button class="filter-btn secondary" onclick="clearFilters()">Clear</button>
            </div>
            <div id="reportModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="close-btn" onclick="closeReportModal()">&times;</span>
                    <h2>Report Issue with Scanned Item</h2>
                    <form id="reportForm">
                        <input type="hidden" id="reportScanId" name="scan_id">
                        <div class="form-group">
                            <label for="issueDescription">Describe the issue:</label>
                            <textarea id="issueDescription" name="description" rows="4" required
                                placeholder="e.g., Felt nauseous after eating, allergic reaction, packaging issue..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Severity (Optional):</label>
                            <div class="radio-group">
                                <label><input type="radio" name="severity" value="mild"> Mild</label>
                                <label><input type="radio" name="severity" value="moderate"> Moderate</label>
                                <label><input type="radio" name="severity" value="severe"> Severe</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="contactConsent">Okay to contact you for follow-up? (Optional)</label>
                            <input type="checkbox" id="contactConsent" name="contact_consent" value="yes"> Yes
                        </div>
                        <button type="button" class="submit-btn" onclick="submitReport()">Submit Report</button>
                    </form>
                    <div id="reportStatus" style="margin-top: 15px;"></div>
                </div>
            </div>

            <div id="scansContainer" class="loading">
                Loading your scans...
            </div>
        </div>
    </div>

    <script>
        let allScans = [];

        async function loadScans() {
            try {
                const response = await fetch('/api/get-all-scans');
                const data = await response.json();

                if (data.error) {
                    window.location.href = '/';
                    return;
                }

                allScans = data.scans;
                updateStats(data.stats);
                displayScans(allScans);

            } catch (error) {
                console.error('Error loading scans:', error);
                document.getElementById('scansContainer').innerHTML = `
                    <div class="empty-state">
                        <h2>Error Loading Scans</h2>
                        <p>Could not load your scans. Please try again.</p>
                    </div>
                `;
            }
        }

        function updateStats(stats) {
            document.getElementById('totalScans').textContent = stats.total_scans || 0;
            document.getElementById('recentScans').textContent = stats.recent_scans || 0;
            document.getElementById('highRiskCount').textContent = stats.high_risk_count || 0;
        }

        function displayScans(scans) {
            const container = document.getElementById('scansContainer');

            if (!scans || scans.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h2>No Scans Yet</h2>
                        <p>Start scanning food labels to track your nutrition!</p>
                        <a href="/scan-label" class="hero-btn">Scan Your First Item</a>
                    </div>
                `;
                return;
            }

            container.className = 'scans-grid';
            container.innerHTML = scans.map(scan => createScanCard(scan)).join('');
        }

        function createScanCard(scan) {
            const productName = scan.product_info?.name || 'Unknown Product';
            const scanDate = new Date(scan.scan_date).toLocaleString();
            const nutrients = scan.nutrition_analysis?.structured_nutrients || [];
            const summary = scan.nutrition_analysis?.summary || {};

            const keyNutrients = nutrients.filter(n =>
                ['protein', 'carbohydrates', 'carbs', 'fat', 'fats', 'sugar', 'sodium'].includes(n.nutrient?.toLowerCase())
            ).slice(0, 4);

            const highCount = summary.high_risk_count || 0;
            const normalCount = summary.normal_count || 0;
            const lowCount = summary.low_risk_count || 0;

            return `
                <div class="scan-card">
                    <div class="scan-header">
                        <h3>${productName}</h3>
                        <div class="scan-date">üìÖ ${scanDate}</div>
                    </div>
                    <div class="scan-body">
                        <div class="nutrient-summary">
                            ${keyNutrients.map(n => `
                                <div class="nutrient-item">
                                    <strong>${n.value}${n.unit}</strong>
                                    <span>${n.nutrient}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="status-badges">
                            ${highCount > 0 ? `<span class="badge high">‚ö†Ô∏è ${highCount} High</span>` : ''}
                            ${normalCount > 0 ? `<span class="badge normal">‚úì ${normalCount} Normal</span>` : ''}
                            ${lowCount > 0 ? `<span class="badge low">‚ö° ${lowCount} Low</span>` : ''}
                        </div>
                        <div class="scan-actions">
                            <button class="action-btn view" onclick="viewScan('${scan._id}')">View Details</button>
                            <button class="action-btn report" onclick="openReportModal('${scan._id}')">Report Issue</button>
                            <button class="action-btn delete" onclick="deleteScan('${scan._id}')">Delete</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const sortBy = document.getElementById('sortSelect').value;

            let filtered = [...allScans];

            if (searchTerm) {
                filtered = filtered.filter(scan =>
                    (scan.product_info?.name || '').toLowerCase().includes(searchTerm)
                );
            }

            filtered.sort((a, b) => {
                switch (sortBy) {
                    case 'date-desc':
                        return new Date(b.scan_date) - new Date(a.scan_date);
                    case 'date-asc':
                        return new Date(a.scan_date) - new Date(b.scan_date);
                    case 'name-asc':
                        return (a.product_info?.name || '').localeCompare(b.product_info?.name || '');
                    case 'name-desc':
                        return (b.product_info?.name || '').localeCompare(a.product_info?.name || '');
                    default:
                        return 0;
                }
            });

            displayScans(filtered);
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('sortSelect').value = 'date-desc';
            displayScans(allScans);
        }

        function viewScan(scanId) {
            window.location.href = `/view-scan/${scanId}`;
        }

        function deleteScan(scanId) {
            if (!confirm("Are you sure you want to delete this scan? This action cannot be undone.")) {
                return;
            }

            // Get the token from the meta tag
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            // ADD THIS LINE
            console.log("Attempting to delete ID:", scanId, "Type:", typeof scanId, "Token:", csrfToken);
            if (!scanId || typeof scanId !== 'string' || scanId.trim() === '') {
                console.error("‚ùå Invalid scanId passed to deleteScan:", scanId);
                alert("Error: Cannot delete scan due to an invalid ID.");
                return;
            }

            fetch(`/api/delete-scan/${scanId}`, {
                method: "DELETE",
                credentials: "include",
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": csrfToken // <-- This header sends the token
                }
            })
                .then(async (res) => {
                    // ... (rest of your function is perfect)
                    const text = await res.text();
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.error("‚ùå Non-JSON response:", text);
                        throw new Error("Invalid response format from server.");
                    }
                })
                .then((data) => {
                    if (data.success) {
                        alert("‚úÖ Scan deleted successfully!");
                        loadScans();
                    } else if (data.error === "Unauthorized") {
                        alert("‚ö†Ô∏è Your session has expired. Please log in again.");
                        window.location.href = "/";
                    } else {
                        alert(`‚ö†Ô∏è ${data.error || "Failed to delete scan"}`);
                    }
                })
                .catch((err) => {
                    console.error("Delete error:", err);
                    alert("‚ùå Could not delete scan. Check console for details.");
                });
        }


        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(applyFilters, 500);
        });

        document.getElementById('sortSelect').addEventListener('change', applyFilters);

        window.onload = loadScans;

        // Smooth scroll initialization
        const lenis = new Lenis({
            duration: 1.2,
            easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
            smoothWheel: true
        });

        function raf(time) {
            lenis.raf(time);
            requestAnimationFrame(raf);
        }

        requestAnimationFrame(raf);
        function openReportModal(scanId) {
            document.getElementById('reportScanId').value = scanId;
            document.getElementById('reportForm').reset(); // Clear previous entries
            document.getElementById('reportStatus').textContent = ''; // Clear status message
            document.getElementById('reportStatus').className = '';
            document.getElementById('reportModal').style.display = 'block';
        }

        function closeReportModal() {
            document.getElementById('reportModal').style.display = 'none';
        }

        async function submitReport() {
            const form = document.getElementById('reportForm');
            const scanId = document.getElementById('reportScanId').value;
            const description = document.getElementById('issueDescription').value;
            const severityRadio = form.querySelector('input[name="severity"]:checked');
            const severity = severityRadio ? severityRadio.value : null;
            const contactConsent = document.getElementById('contactConsent').checked;
            const statusDiv = document.getElementById('reportStatus');
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            if (!description) {
                statusDiv.textContent = 'Please describe the issue.';
                statusDiv.className = 'error';
                return;
            }

            statusDiv.textContent = 'Submitting...';
            statusDiv.className = '';

            try {
                const response = await fetch(`/api/submit-report/${scanId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json', // Send as JSON
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ // Convert data to JSON string
                        description: description,
                        severity: severity,
                        contact_consent: contactConsent
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    statusDiv.textContent = 'Report submitted successfully!';
                    statusDiv.className = 'success';
                    // Optionally close modal after a delay
                    setTimeout(closeReportModal, 2000);
                } else {
                    statusDiv.textContent = `Error: ${data.error || 'Could not submit report.'}`;
                    statusDiv.className = 'error';
                }
            } catch (error) {
                console.error('Error submitting report:', error);
                statusDiv.textContent = 'Network error. Please try again.';
                statusDiv.className = 'error';
            }
        }

        // Close modal if user clicks outside of it
        window.onclick = function (event) {
            const modal = document.getElementById('reportModal');
            if (event.target == modal) {
                closeReportModal();
            }
        }
    </script>
</body>

</html>